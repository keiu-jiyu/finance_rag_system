{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="panel">
        <h2>ğŸ“š çŸ¥è¯†åº“ç®¡ç†</h2>
        
        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div class="stats-box">
            <h3>çŸ¥è¯†åº“ç»Ÿè®¡</h3>
            <div class="stat-items">
                <div class="stat-item">
                    <span class="stat-label">Queryåº“</span>
                    <span class="stat-value" id="query-count">--</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">QAåº“</span>
                    <span class="stat-value" id="qa-count">--</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Docåº“</span>
                    <span class="stat-value" id="doc-count">--</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">æ€»è®¡</span>
                    <span class="stat-value" id="total-count">--</span>
                </div>
            </div>
        </div>

        <!-- ä¸Šä¼ è¡¨å• -->
        <div class="upload-section">
            <h3>ğŸ“¤ ä¸Šä¼ æ–‡ä»¶</h3>
            
            <div class="form-group">
                <label>é€‰æ‹©çŸ¥è¯†åº“ç±»å‹</label>
                <select id="kb-type">
                    <option value="docs">ğŸ“„ æ–‡æ¡£åº“ (PDF/TXT)</option>
                    <option value="qa">â“ QAåº“ (JSON)</option>
                </select>
            </div>

            <div class="upload-area" id="upload-area">
                <input type="file" id="file-input" multiple accept=".pdf,.txt,.json">
                <p>ğŸ–±ï¸ ç‚¹å‡»é€‰æ‹©æ–‡ä»¶æˆ–æ‹–æ”¾åˆ°è¿™é‡Œ</p>
                <p style="font-size: 12px;">æ”¯æŒæ ¼å¼: PDFã€TXTã€JSON</p>
            </div>

            <button class="btn btn-primary" id="upload-btn">ä¸Šä¼ </button>
        </div>

        <!-- ä¸Šä¼ çŠ¶æ€ -->
        <div id="upload-status" class="status-box" style="display: none;">
            <p id="status-message"></p>
            <div class="progress-bar" id="progress-bar"></div>
        </div>

        <!-- QAæ ·ä¾‹ -->
        <div class="sample-section">
            <h3>ğŸ“‹ QA JSONæ ¼å¼ç¤ºä¾‹</h3>
            <pre><code>[
  {
    "question": "ç¾è”å‚¨åŠ æ¯å¯¹è‚¡å¸‚æœ‰ä»€ä¹ˆå½±å“ï¼Ÿ",
    "answer": "åŠ æ¯ä¼šæé«˜ä¼ä¸šèèµ„æˆæœ¬ï¼Œé™ä½ç›ˆåˆ©é¢„æœŸï¼Œå¯èƒ½å¯¼è‡´è‚¡ä»·ä¸‹è·Œï¼Œå°¤å…¶æ˜¯æˆé•¿è‚¡"
  },
  {
    "question": "ä»€ä¹ˆæ˜¯é»‘å¤©é¹…äº‹ä»¶ï¼Ÿ",
    "answer": "é»‘å¤©é¹…äº‹ä»¶æŒ‡æç½•è§ã€éš¾ä»¥é¢„æµ‹ä½†å½±å“å·¨å¤§çš„äº‹ä»¶ï¼Œå…·æœ‰ä¸‰ä¸ªç‰¹ç‚¹ï¼šä¸å¯é¢„æµ‹æ€§ã€æç«¯å½±å“ã€äº‹åå¯è§£é‡Šæ€§"
  }
]</code></pre>
        </div>
    </div>
</div>

<script src="{{ url_for('static', filename='js/chat.js') }}"></script>
<script>
    // åŠ è½½ç»Ÿè®¡ä¿¡æ¯
    function loadStats() {
        fetch('/api/kb-stats')
            .then(r => r.json())
            .then(data => {
                if (data.code === 200) {
                    document.getElementById('query-count').textContent = data.data.query_count;
                    document.getElementById('qa-count').textContent = data.data.qa_count;
                    document.getElementById('doc-count').textContent = data.data.doc_count;
                    document.getElementById('total-count').textContent = data.data.total_count;
                }
            });
    }

    // æ–‡ä»¶ä¸Šä¼ é€»è¾‘
    const uploadArea = document.getElementById('upload-area');
    const fileInput = document.getElementById('file-input');
    const uploadBtn = document.getElementById('upload-btn');
    const statusBox = document.getElementById('upload-status');
    const statusMsg = document.getElementById('status-message');

    uploadArea.addEventListener('click', () => fileInput.click());
    
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.style.borderColor = '#4CAF50';
    });

    uploadArea.addEventListener('dragleave', (e) => {
        uploadArea.style.borderColor = '#ddd';
    });

    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.style.borderColor = '#ddd';
        fileInput.files = e.dataTransfer.files;
    });

    uploadBtn.addEventListener('click', async () => {
        const files = fileInput.files;
        const kbType = document.getElementById('kb-type').value;
        
        if (files.length === 0) {
            alert('è¯·é€‰æ‹©æ–‡ä»¶');
            return;
        }

        statusBox.style.display = 'block';
        
        for (let file of files) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('type', kbType);
            
            statusMsg.textContent = `æ­£åœ¨ä¸Šä¼ : ${file.name}...`;
            
            try {
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                statusMsg.textContent = result.msg;
                
                if (result.code === 200) {
                    loadStats();
                }
            } catch (e) {
                statusMsg.textContent = `âŒ ä¸Šä¼ å¤±è´¥: ${e.message}`;
            }
        }
    });

    // åˆå§‹åŒ–
    loadStats();
    setInterval(loadStats, 5000);
</script>
{% endblock %}