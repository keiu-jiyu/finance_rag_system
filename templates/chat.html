{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="chat-panel">
        <div class="chat-header">
            <h2>ğŸ¤– æ™ºèƒ½å®¢æœ</h2>
            <p>åŸºäºRAGçš„äº”å±‚çº§è”æ£€ç´¢ç³»ç»Ÿ</p>
        </div>

        <!-- èŠå¤©è®°å½• -->
        <div class="chat-messages" id="chat-messages"></div>

        <!-- ä¿¡æ¯ç›’ -->
        <div class="info-box" id="info-box" style="display: none;">
            <div class="info-item">
                <strong>ğŸ“ æ£€ç´¢å±‚çº§:</strong> <span id="info-layer"></span>
            </div>
            <div class="info-item">
                <strong>ğŸ“š æ•°æ®æº:</strong> <span id="info-source"></span>
            </div>
            <div class="info-item">
                <strong>ğŸ¯ ç½®ä¿¡åº¦:</strong> <span id="info-confidence"></span>
            </div>
            <div class="info-item" id="contexts-info" style="display: none;">
                <strong>ğŸ“– å‚è€ƒæ–‡çŒ®:</strong>
                <div id="contexts-list" style="margin-top: 10px;"></div>
            </div>
        </div>

        <!-- è¾“å…¥æ¡† -->
        <div class="chat-input-area">
            <input 
                type="text" 
                id="user-input" 
                placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜..."
                @keyup.enter="sendMessage"
            >
            <button id="send-btn" class="btn btn-primary">å‘é€</button>
        </div>
    </div>
</div>

<script src="{{ url_for('static', filename='js/chat.js') }}"></script>
<script>
    const chatMessages = document.getElementById('chat-messages');
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');
    const infoBox = document.getElementById('info-box');

    // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©æ¡†
    function addMessage(text, sender = 'user', info = null) {
        const msgDiv = document.createElement('div');
        msgDiv.className = `message message-${sender}`;
        msgDiv.textContent = text;
        chatMessages.appendChild(msgDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;

        if (info) {
            showInfo(info);
        }
    }

    // æ˜¾ç¤ºæ£€ç´¢ä¿¡æ¯
    function showInfo(info) {
        document.getElementById('info-layer').textContent = `ç¬¬${info.layer}å±‚ - ${['', 'Queryåº“', 'QAåº“', 'Docåº“', 'BM25', 'è‡ªç”±ç”Ÿæˆ'][info.layer]}`;
        document.getElementById('info-source').textContent = info.source;
        document.getElementById('info-confidence').textContent = (info.confidence * 100).toFixed(1) + '%';
        
        if (info.contexts && info.contexts.length > 0) {
            const contextsList = document.getElementById('contexts-list');
            contextsList.innerHTML = info.contexts.map((c, i) => `
                <div style="margin: 5px 0; font-size: 12px; color: #666;">
                    ğŸ“Œ å‚è€ƒ${i+1}: ${c.substring(0, 100)}...
                </div>
            `).join('');
            document.getElementById('contexts-info').style.display = 'block';
        }
        
        infoBox.style.display = 'block';
    }

    // å‘é€æ¶ˆæ¯
    async function sendMessage() {
        const query = userInput.value.trim();
        if (!query) return;

        // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
        addMessage(query, 'user');
        userInput.value = '';
        sendBtn.disabled = true;

        try {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({query})
            });

            const result = await response.json();
            
            if (result.code === 200) {
                addMessage(result.data.answer, 'assistant', result.data);
            } else {
                addMessage(`âŒ é”™è¯¯: ${result.msg}`, 'assistant');
            }
        } catch (e) {
            addMessage(`âŒ è¯·æ±‚å¤±è´¥: ${e.message}`, 'assistant');
        } finally {
            sendBtn.disabled = false;
            userInput.focus();
        }
    }

    sendBtn.addEventListener('click', sendMessage);
    userInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
    });

    // æ¬¢è¿æ¶ˆæ¯
    setTimeout(() => {
        addMessage('ğŸ‘‹ æ¬¢è¿ä½¿ç”¨é‡‘èå®¢æœç³»ç»Ÿï¼è¯·è¾“å…¥æ‚¨çš„é—®é¢˜ï¼Œæˆ‘ä¼šä¸ºæ‚¨æŸ¥è¯¢çŸ¥è¯†åº“å¹¶ç»™å‡ºä¸“ä¸šå›ç­”ã€‚');
    }, 500);
</script>
{% endblock %}